name: Fetch Latest ATM10 Sky Server Pack Link (with HTML Fallback, Build htmlq from Source)

on:
  workflow_dispatch:
  push:
    branches:
      - curseforge-test

jobs:
  get-server-pack:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install jq and build htmlq from source
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl rustc cargo
          cargo install htmlq
          sudo mv ~/.cargo/bin/htmlq /usr/local/bin/
          htmlq --version

      - name: Fetch latest server pack link
        env:
          API_KEY: ${{ secrets.CURSEFORGE_API_KEY }}
          PROJECT_ID: 1298402
        run: |
          echo "ðŸ” Getting latest main file ID..."
          main_file_id=$(curl -s -H "x-api-key: $API_KEY" \
            "https://api.curseforge.com/v1/mods/${PROJECT_ID}/files" \
            | jq '.data[0].id')

          echo "Latest main file ID: $main_file_id"

          echo "ðŸ“‚ Trying API additional-files endpoint..."
          response=$(curl -s -H "x-api-key: $API_KEY" \
            "https://api.curseforge.com/v1/mods/${PROJECT_ID}/files/${main_file_id}/additional-files")

          FILE_ID=$(echo "$response" | jq '.data[0].id')
          FILENAME=$(echo "$response" | jq -r '.data[0].fileName')

          if [ -z "$FILE_ID" ] || [ -z "$FILENAME" ]; then
            echo "âš ï¸ No server pack in API additional-files â€” scraping HTML..."
            html=$(curl -s "https://www.curseforge.com/minecraft/modpacks/all-the-mods-10-sky/files/${main_file_id}/additional-files")

            # Extract first file link from HTML that isn't the main file
            server_file_id=$(echo "$html" | htmlq --attribute href 'a[href*="/files/"]' \
              | grep '/files/' \
              | grep -v "${main_file_id}" \
              | head -n 1 \
              | awk -F'/files/' '{print $2}' \
              | cut -d'/' -f1)

            if [ -z "$server_file_id" ]; then
              echo "âŒ Could not find server pack file ID in HTML."
              exit 1
            fi

            echo "Found server pack file ID: $server_file_id"

            # Get filename from API
            file_info=$(curl -s -H "x-api-key: $API_KEY" \
              "https://api.curseforge.com/v1/mods/${PROJECT_ID}/files/${server_file_id}")

            FILE_ID=$(echo "$file_info" | jq '.data.id')
            FILENAME=$(echo "$file_info" | jq -r '.data.fileName')
          fi

          if [ -z "$FILE_ID" ] || [ -z "$FILENAME" ]; then
            echo "âŒ No server pack found."
            exit 1
          fi

          FIRST_PART=${FILE_ID:0:4}
          SECOND_PART=${FILE_ID: -3}
          DIRECT_URL="https://mediafilez.forgecdn.net/files/${FIRST_PART}/${SECOND_PART}/${FILENAME}"

          echo "âœ… Latest server pack direct link:"
          echo "$DIRECT_URL"

          echo "$DIRECT_URL" > latest_server_pack_link.txt

      - name: Upload server pack link as artifact
        uses: actions/upload-artifact@v4
        with
