name: Test CurseForge Latest File Link

on:
  workflow_dispatch:   # ‚úÖ Enables manual run from Actions tab
  push:
    branches:
      - curseforge-test  # Runs automatically on pushes to this branch

jobs:
  get-latest-file:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Fetch latest file link
        env:
          API_KEY: ${{ secrets.CURSEFORGE_API_KEY }}
          PROJECT_ID: 1298402
        run: |
          echo "üîç Fetching all files for project $PROJECT_ID..."
          response=$(curl -s -H "x-api-key: $API_KEY" \
            "https://api.curseforge.com/v1/mods/${PROJECT_ID}/files")

          echo "üìÑ All files from CurseForge:"
          echo "$response" | jq -r '.data[] | "\(.id) \(.fileName)"'

          # Get the newest file (first in the list)
          FILE_ID=$(echo "$response" | jq '.data[0].id')
          FILENAME=$(echo "$response" | jq -r '.data[0].fileName')

          if [ -z "$FILE_ID" ] || [ -z "$FILENAME" ]; then
            echo "‚ùå No file found."
            exit 1
          fi

          FIRST_PART=${FILE_ID:0:4}
          SECOND_PART=${FILE_ID: -3}
          DIRECT_URL="https://mediafilez.forgecdn.net/files/${FIRST_PART}/${SECOND_PART}/${FILENAME}"

          echo "‚úÖ Latest build direct link:"
          echo "$DIRECT_URL"
