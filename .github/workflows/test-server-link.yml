name: Test CurseForge Server Link

on:
  workflow_dispatch:   # ‚úÖ This enables the "Run workflow" button in the Actions tab
  push:
    branches:
      - curseforge-test  # Runs automatically on pushes to this branch

jobs:
  get-server-link:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Fetch latest server build link
        env:
          API_KEY: ${{ secrets.CURSEFORGE_API_KEY }}
          PROJECT_ID: 1298402
        run: |
          echo "Fetching latest files for project $PROJECT_ID..."
          response=$(curl -s -H "x-api-key: $API_KEY" \
            "https://api.curseforge.com/v1/mods/${PROJECT_ID}/files")

          echo "üìÑ Available files from CurseForge:"
          echo "$response" | jq -r '.data[].fileName'

          # Filter for server packs anywhere in the list
          FILE_ID=$(echo "$response" | jq '.data[] | select(.fileName | test("server-"; "i")) | .id' | head -n 1)
          FILENAME=$(echo "$response" | jq -r '.data[] | select(.fileName | test("server-"; "i")) | .fileName' | head -n 1)

          if [ -z "$FILE_ID" ] || [ -z "$FILENAME" ]; then
            echo "‚ùå No server build found."
            exit 1
          fi

          FIRST_PART=${FILE_ID:0:4}
          SECOND_PART=${FILE_ID: -3}
          DIRECT_URL="https://mediafilez.forgecdn.net/files/${FIRST_PART}/${SECOND_PART}/${FILENAME}"

          echo "‚úÖ Latest server build direct link:"
          echo "$DIRECT_URL"
